# ESP32 Draggy Performance Logger - 系统架构

## 项目概述

基于ESP32的汽车性能记录器，类似于RC Box Draggy，集成GPS定位、IMU姿态检测和性能分析功能。

## 核心功能

### 🚗 性能测试
- **0-100km/h 加速时间**: 自动检测并记录加速性能
- **100-0km/h 制动距离**: 制动性能测试
- **最大G力监测**: 记录加速、制动、横向G力峰值
- **圈速计算**: 支持设定起点/终点进行圈速测试
- **功率估算**: 基于速度和加速度估算车辆功率

### 📡 数据采集
- **GPS定位**: GT-U7模块提供精确位置和速度数据
- **IMU传感器**: MPU6050提供6轴姿态和加速度数据
- **数据融合**: 结合GPS和IMU数据提升测量精度
- **实时显示**: OLED屏幕显示当前状态和测试结果

### 🌐 用户界面
- **多模式显示**: BOOT键切换IMU/GPS/性能/WiFi模式
- **Web界面**: 手机/电脑无线查看实时数据
- **数据存储**: SPIFFS文件系统保存测试记录
- **串口调试**: 详细的调试信息输出

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    ESP32 主控制器                           │
├─────────────────┬─────────────────┬─────────────────────────┤
│  传感器层       │  数据处理层      │  用户界面层              │
├─────────────────┼─────────────────┼─────────────────────────┤
│ ┌─────────────┐ │ ┌─────────────┐ │ ┌─────────────────────┐ │
│ │   MPU6050   │ │ │数据融合引擎  │ │ │    OLED显示屏        │ │
│ │ 6轴IMU传感器 │→│ │ IMU+GPS     │→│ │ 4种显示模式          │ │
│ │ I2C: 0x68   │ │ │ 滤波算法    │ │ │ 128x64 SSD1306      │ │
│ └─────────────┘ │ └─────────────┘ │ └─────────────────────┘ │
│ ┌─────────────┐ │ ┌─────────────┐ │ ┌─────────────────────┐ │
│ │   GT-U7     │ │ │性能分析器    │ │ │    Web服务器         │ │
│ │ GPS定位模块  │→│ │ 加速测试    │→│ │ WiFi: ESP32-IMU     │ │
│ │ UART: 9600  │ │ │ 制动测试    │ │ │ IP: 192.168.4.1     │ │
│ └─────────────┘ │ │ G力分析     │ │ └─────────────────────┘ │
│                 │ └─────────────┘ │ ┌─────────────────────┐ │
│                 │ ┌─────────────┐ │ │    串口调试          │ │
│                 │ │数据存储系统  │ │ │ 115200 baud         │ │
│                 │ │ SPIFFS      │ │ │ 多种打印模式         │ │
│                 │ │ JSON格式    │ │ └─────────────────────┘ │
│                 │ └─────────────┘ │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
```

## 模块详细设计

### 1. 传感器数据采集模块

#### MPU6050 IMU传感器
- **连接**: I2C总线 (GPIO21/22)
- **功能**: 3轴加速度计 + 3轴陀螺仪
- **采样频率**: 100Hz
- **数据滤波**: 低通滤波器减少震动噪声
- **校准**: 车辆安装后自动零点校准

#### GT-U7 GPS模块
- **连接**: UART2 (GPIO16/17)
- **波特率**: 9600bps
- **更新频率**: 10Hz
- **精度**: 2.5m CEP (开阔地带)
- **冷启动**: <30秒 (通常)

### 2. 数据融合与性能分析

#### 数据融合算法
```cpp
// 融合GPS速度和IMU加速度数据
float fused_acceleration = (gps_speed_delta / time_delta) * gps_weight + 
                          (imu_accel_filtered) * imu_weight;

// G力计算 (考虑车辆安装角度)
float longitudinal_g = (accel_x_corrected) / 9.81;
float lateral_g = (accel_y_corrected) / 9.81;
```

#### 性能测试算法
- **加速测试**: 检测5km/h→100km/h过程，记录关键时间点
- **制动测试**: 检测95km/h→5km/h过程，计算制动时间
- **G力监测**: 实时计算并记录峰值G力
- **功率估算**: 基于阻力模型和加速度计算瞬时功率

### 3. 用户界面系统

#### OLED显示模式
- **模式0 - IMU数据**: 3D立方体姿态显示
- **模式1 - WiFi信息**: 连接二维码和网络信息
- **模式2 - GPS状态**: 速度、卫星数量、定位状态
- **模式3 - 性能数据**: 当前G力、测试结果、峰值记录

#### Web界面功能
- **实时数据**: 200ms刷新频率
- **三个标签页**: IMU/GPS/性能数据分别显示
- **响应式设计**: 适配手机和电脑屏幕
- **状态指示**: 实时显示加速/制动/转弯状态

### 4. 数据存储系统

#### SPIFFS文件系统
```json
{
  "gps": {
    "max_speed": 120.5,
    "distance": 5680.2
  },
  "performance": {
    "accel_0_100": 8.32,
    "brake_100_0": 3.45,
    "max_accel_g": 0.85,
    "max_brake_g": 1.12,
    "max_lateral_g": 0.76,
    "lap_count": 3,
    "best_lap": 78.96
  },
  "timestamp": 1641234567890
}
```

## 硬件连接

### 引脚分配
| 功能 | ESP32引脚 | 设备 | 备注 |
|------|-----------|------|------|
| I2C SDA | GPIO21 | MPU6050, OLED | 共享总线 |
| I2C SCL | GPIO22 | MPU6050, OLED | 共享总线 |
| UART2 RX | GPIO16 | GT-U7 TX | GPS数据接收 |
| UART2 TX | GPIO17 | GT-U7 RX | GPS配置发送 |
| BOOT键 | GPIO0 | 内置按键 | 切换显示模式 |

### 电源设计
- **工作电压**: 3.3V (所有传感器)
- **工作电流**: ~150mA (WiFi开启)
- **推荐电源**: 5V/1A USB适配器或车载电源

## 软件架构

### 主程序流程
```
setup() {
    初始化串口通信
    初始化I2C总线 (MPU6050 + OLED)
    初始化GPS模块 (UART)
    初始化性能分析器
    初始化WiFi热点
    启动Web服务器
}

loop() {
    处理Web请求
    检测BOOT按键 (切换显示模式)
    处理串口命令
    
    定时任务 (100ms周期) {
        读取MPU6050数据
        更新GPS数据
        执行数据融合
        更新显示屏内容
        输出调试信息
    }
}
```

### 文件结构
```
src/
├── main.cpp              # 主程序和用户界面
├── mpu6050.h/.cpp       # MPU6050传感器驱动
├── gps_module.h/.cpp    # GPS模块和性能测试
└── performance_analyzer.h/.cpp  # 数据融合和性能分析

data/
└── index.html           # Web界面 (SPIFFS)
```

## 性能特点

### 测量精度
- **速度精度**: ±0.1 km/h (GPS)
- **时间精度**: ±10ms (系统时钟)
- **G力精度**: ±0.05G (IMU滤波后)
- **位置精度**: ±2.5m (GPS开阔地带)

### 系统响应
- **数据更新率**: 100ms (10Hz)
- **显示刷新率**: 100ms
- **Web界面刷新**: 200ms
- **GPS更新率**: 100ms (10Hz)

### 数据处理能力
- **同时处理**: GPS + IMU + Web + 显示
- **内存使用**: ~60% (ESP32 320KB)
- **存储容量**: ~1.5MB (SPIFFS可用)
- **连接设备**: 最多4个WiFi客户端

## 扩展性设计

### 硬件扩展接口
- **剩余GPIO**: 可接入额外传感器
- **ADC通道**: 可监测电池电压
- **SPI总线**: 可接入SD卡存储

### 软件功能扩展
- **蓝牙连接**: 与手机App通信
- **更多测试模式**: 1/4英里加速等
- **数据导出**: CSV格式导出测试数据
- **云端同步**: WiFi连接后上传数据

这个架构提供了一个完整的汽车性能测试解决方案，结合了精确的传感器数据、智能的数据融合算法和直观的用户界面。