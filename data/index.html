<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 Draggy Racing Logger</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font:14px Arial,sans-serif;background:#1a1a2e;color:#eee;padding:10px}
.c{max-width:900px;margin:0 auto;background:#16213e;padding:15px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.5)}
h1{text-align:center;margin-bottom:12px;font-size:18px;color:#00ff88}
.s{display:flex;justify-content:space-between;background:#0f3460;padding:6px 10px;border-radius:5px;margin-bottom:12px;font-size:11px}
#st{font-weight:bold;color:#00ff88}
#tm{color:#888}
.tabs{display:flex;margin-bottom:12px;border-radius:8px;overflow:hidden;background:#0f3460}
.tab{flex:1;padding:8px;text-align:center;cursor:pointer;background:#0f3460;border:none;font-size:11px;color:#888;transition:all .2s}
.tab.active{background:#e94560;color:white}
.tab:hover:not(.active){background:#1a1a2e;color:#fff}
.section{display:none}
.section.active{display:block}
.g{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:12px}
.b{padding:8px;border:1px solid #0f3460;border-radius:6px;text-align:center;background:#1a1a2e}
.b.speed{border-color:#00ff88;background:linear-gradient(135deg,#1a1a2e,#0a2a1a)}
.b.gforce{border-color:#e94560;background:linear-gradient(135deg,#1a1a2e,#2a1a1a)}
.v{font:bold 16px monospace;color:#00ff88;display:block;margin-bottom:2px}
.v.red{color:#e94560}
.v.yellow{color:#ffd700}
.v.big{font-size:24px}
.l{font-size:8px;color:#666;text-transform:uppercase}
.chart-box{background:#0a0a1a;border-radius:6px;padding:8px;margin-bottom:10px;border:1px solid #0f3460}
.chart-title{font-size:11px;color:#888;margin-bottom:6px;display:flex;justify-content:space-between}
.legend{display:flex;gap:12px;font-size:9px}
.legend-item{display:flex;align-items:center;gap:3px}
.legend-dot{width:10px;height:3px;border-radius:2px}
canvas{width:100%;display:block}
.controls{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.btn{background:#e94560;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:10px;transition:all .2s}
.btn:hover{background:#ff6b6b}
.btn.green{background:#00cc66}
.btn.green:hover{background:#00ff88}
.btn.blue{background:#0066cc}
.btn.orange{background:#ff8800}
.rec-dot{display:inline-block;width:8px;height:8px;background:#e94560;border-radius:50%;margin-right:4px;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.stats-row{display:flex;justify-content:space-between;background:#0a0a1a;padding:6px 10px;border-radius:4px;margin-bottom:6px;font-size:10px}
.stats-label{color:#666}
.stats-value{color:#00ff88;font-family:monospace}
.log-panel{background:#0a0a1a;border-radius:6px;padding:8px;max-height:180px;overflow-y:auto;font-family:monospace;font-size:9px;border:1px solid #0f3460}
.log-row{padding:2px 0;border-bottom:1px solid #1a1a2e;display:grid;grid-template-columns:70px 50px 50px 50px 30px 40px;gap:5px}
.log-row.header{color:#666;border-bottom:2px solid #0f3460;font-weight:bold}
.log-time{color:#666}
.log-speed{color:#00ff88}
.log-accel{color:#e94560}
.log-lat{color:#ffd700}
.log-sats{color:#0088ff}
.log-event{color:#ff8800}
.export-box{background:#0f3460;padding:8px;border-radius:4px;margin-top:8px;font-size:10px}
.footer{text-align:center;font-size:9px;color:#444;margin-top:12px;padding-top:8px;border-top:1px solid #0f3460}
select,input{background:#0f3460;color:#fff;border:1px solid #1a1a2e;padding:4px 8px;border-radius:3px;font-size:10px}
.gps-badge{padding:3px 6px;border-radius:8px;font-size:9px;display:inline-block}
.gps-badge.fix{background:#00cc66;color:#000}
.gps-badge.search{background:#ffd700;color:#000}
.gps-badge.off{background:#666;color:#fff}
</style>
</head>
<body>
<div class="c">
<h1>ğŸï¸ ESP32 Draggy Racing Logger</h1>
<div class="s">
<div><span id="st">è¿æ¥ä¸­...</span> <span id="recStatus"></span></div>
<div id="tm">--</div>
</div>

<div class="tabs">
<button class="tab active" onclick="showTab('live')">ğŸ“Š å®æ—¶æ›²çº¿</button>
<button class="tab" onclick="showTab('perf')">âš¡ æ€§èƒ½</button>
<button class="tab" onclick="showTab('log')">ğŸ“ è®°å½•</button>
<button class="tab" onclick="showTab('export')">ğŸ’¾ å¯¼å‡º</button>
</div>

<!-- å®æ—¶æ›²çº¿é¡µé¢ -->
<div class="section active" id="live">
<div class="g">
<div class="b speed"><span class="v big" id="speed">0.0</span><div class="l">é€Ÿåº¦ km/h</div></div>
<div class="b gforce"><span class="v red" id="accelG">0.00</span><div class="l">çºµå‘G</div></div>
<div class="b gforce"><span class="v yellow" id="lateralG">0.00</span><div class="l">æ¨ªå‘G</div></div>
<div class="b"><span class="v" id="sats">--</span><div class="l">å«æ˜Ÿ</div></div>
</div>

<div class="chart-box">
<div class="chart-title">
<span>é€Ÿåº¦æ›²çº¿</span>
<div class="legend">
<div class="legend-item"><div class="legend-dot" style="background:#00ff88"></div>èåˆ</div>
<div class="legend-item"><div class="legend-dot" style="background:#0088ff"></div>GPS</div>
</div>
</div>
<canvas id="speedChart" height="100"></canvas>
</div>

<div class="chart-box">
<div class="chart-title">
<span>GåŠ›æ›²çº¿</span>
<div class="legend">
<div class="legend-item"><div class="legend-dot" style="background:#e94560"></div>çºµå‘</div>
<div class="legend-item"><div class="legend-dot" style="background:#ffd700"></div>æ¨ªå‘</div>
</div>
</div>
<canvas id="gforceChart" height="80"></canvas>
</div>

<div class="controls">
<button class="btn green" onclick="toggleRec()" id="recBtn">âº å¼€å§‹è®°å½•</button>
<button class="btn blue" onclick="clearCharts()">ğŸ—‘ æ¸…é™¤</button>
<select id="timeRange" onchange="setTimeRange()">
<option value="30">30ç§’</option>
<option value="60" selected>60ç§’</option>
<option value="120">2åˆ†é’Ÿ</option>
</select>
<span style="color:#666;font-size:10px">æ›´æ–°: <span id="hz">--</span>Hz</span>
</div>
</div>

<!-- æ€§èƒ½æ•°æ®é¡µé¢ -->
<div class="section" id="perf">
<div class="g">
<div class="b speed" style="grid-column:span 2"><span class="v big" id="perfSpeed">0.0</span><div class="l">å½“å‰é€Ÿåº¦ km/h</div></div>
<div class="b"><span class="v" id="maxSpeed">0.0</span><div class="l">æœ€é«˜é€Ÿåº¦</div></div>
<div class="b"><span id="gpsBadge" class="gps-badge off">--</span><div class="l">GPSçŠ¶æ€</div></div>
</div>
<div class="stats-row"><span class="stats-label">0-100 km/h</span><span class="stats-value" id="t100">--</span></div>
<div class="stats-row"><span class="stats-label">100-0 åˆ¶åŠ¨</span><span class="stats-value" id="b100">--</span></div>
<div class="stats-row"><span class="stats-label">æœ€å¤§åŠ é€ŸG</span><span class="stats-value" id="maxAG">--</span></div>
<div class="stats-row"><span class="stats-label">æœ€å¤§åˆ¶åŠ¨G</span><span class="stats-value" id="maxBG">--</span></div>
<div class="stats-row"><span class="stats-label">æœ€å¤§æ¨ªå‘G</span><span class="stats-value" id="maxLG">--</span></div>
<div class="stats-row"><span class="stats-label">HDOPç²¾åº¦</span><span class="stats-value" id="hdop">--</span></div>
</div>

<!-- æ•°æ®è®°å½•é¡µé¢ -->
<div class="section" id="log">
<div class="controls">
<button class="btn green" onclick="toggleRec()" id="recBtn2">âº å¼€å§‹è®°å½•</button>
<button class="btn orange" onclick="markEvent()">ğŸš© æ ‡è®°</button>
<button class="btn" onclick="clearLog()">æ¸…é™¤</button>
<span style="color:#666;font-size:10px">å·²è®°å½•: <span id="logCnt">0</span> æ¡</span>
</div>
<div class="stats-row"><span class="stats-label">è®°å½•æ—¶é•¿</span><span class="stats-value" id="recTime">00:00:00</span></div>
<div class="log-panel" id="logPanel">
<div class="log-row header">
<span>æ—¶é—´</span><span>é€Ÿåº¦</span><span>çºµå‘G</span><span>æ¨ªå‘G</span><span>æ˜Ÿ</span><span>äº‹ä»¶</span>
</div>
</div>
</div>

<!-- å¯¼å‡ºé¡µé¢ -->
<div class="section" id="export">
<h3 style="color:#00ff88;margin-bottom:10px;font-size:13px">ğŸ“Š æ•°æ®å¯¼å‡º</h3>
<div class="controls">
<button class="btn green" onclick="exportCSV()">ğŸ“¥ CSV</button>
<button class="btn blue" onclick="exportJSON()">ğŸ“¥ JSON</button>
<button class="btn orange" onclick="copyData()">ğŸ“‹ å¤åˆ¶</button>
</div>
<div class="export-box">
<strong>è¯´æ˜:</strong> CSVå¯ç”¨Excelæ‰“å¼€ï¼ŒJSONé€‚åˆç¨‹åºå¤„ç†<br>
å­—æ®µ: æ—¶é—´ã€é€Ÿåº¦ã€GåŠ›ã€å«æ˜Ÿã€HDOPã€ä½ç½®
</div>
<div class="stats-row" style="margin-top:10px"><span class="stats-label">æ•°æ®é‡</span><span class="stats-value" id="dataSize">0 KB</span></div>
<div class="stats-row"><span class="stats-label">å¹³å‡é€Ÿåº¦</span><span class="stats-value" id="avgSpd">-- km/h</span></div>
<div class="stats-row"><span class="stats-label">æœ€é«˜é€Ÿåº¦</span><span class="stats-value" id="expMax">-- km/h</span></div>
<div class="stats-row"><span class="stats-label">æœ€å¤§åŠ é€Ÿ</span><span class="stats-value" id="expAcc">-- G</span></div>

<div class="chart-box" style="margin-top:10px">
<div class="chart-title">æ•°æ®é¢„è§ˆ</div>
<canvas id="previewChart" height="60"></canvas>
</div>
</div>

<div class="footer">ESP32 Draggy v2.0 | 10Hz GPS + 200Hz IMU</div>
</div>

<script>
// é…ç½®
const CFG = {
    interval: 150,
    maxPts: 400,
    smooth: 0.3
};

let tab = 'live';
let recording = false;
let recStart = 0;
let recData = [];
let chart = {speed:[],gps:[],accelG:[],lateralG:[],ts:[]};
let smooth = {speed:0,accelG:0,lateralG:0};
let lastT = Date.now();
let cnt = 0;
let timeRange = 60;

// Canvas
let sCtx, gCtx, pCtx;

window.onload = function() {
    sCtx = document.getElementById('speedChart').getContext('2d');
    gCtx = document.getElementById('gforceChart').getContext('2d');
    pCtx = document.getElementById('previewChart').getContext('2d');
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    setInterval(fetchData, CFG.interval);
    setInterval(updateUI, 1000);
    draw();
};

function resizeCanvas() {
    ['speedChart','gforceChart','previewChart'].forEach(id => {
        const c = document.getElementById(id);
        c.width = c.offsetWidth * 2;
        c.height = parseInt(c.getAttribute('height')) * 2;
    });
}

function showTab(t) {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.section').forEach(x => x.classList.remove('active'));
    document.querySelector(`.tab[onclick="showTab('${t}')"]`).classList.add('active');
    document.getElementById(t).classList.add('active');
    tab = t;
    if(t === 'export') updateExport();
}

function fetchData() {
    fetch('/data').then(r => r.json()).then(d => {
        const now = Date.now();
        cnt++;
        if(cnt % 10 === 0) {
            document.getElementById('hz').textContent = (1000/(now-lastT)*10).toFixed(1);
        }
        lastT = now;
        
        document.getElementById('st').textContent = 'ğŸŸ¢ åœ¨çº¿';
        document.getElementById('tm').textContent = new Date().toLocaleTimeString();
        
        processData(d, now);
    }).catch(() => {
        document.getElementById('st').textContent = 'ğŸ”´ ç¦»çº¿';
    });
}

function processData(d, ts) {
    const gpsOk = d.gps && d.gps.valid === 'true' && d.gps.satellites >= 4;
    const rawSpd = gpsOk ? d.gps.speed : 0;
    const rawAG = d.performance ? d.performance.accelG : 0;
    const rawLG = d.performance ? d.performance.lateralG : 0;
    
    smooth.speed = smooth.speed * CFG.smooth + rawSpd * (1 - CFG.smooth);
    smooth.accelG = smooth.accelG * CFG.smooth + rawAG * (1 - CFG.smooth);
    smooth.lateralG = smooth.lateralG * CFG.smooth + rawLG * (1 - CFG.smooth);
    
    if(smooth.speed < 2) smooth.speed = 0;
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('speed').textContent = smooth.speed.toFixed(1);
    document.getElementById('perfSpeed').textContent = smooth.speed.toFixed(1);
    document.getElementById('accelG').textContent = smooth.accelG.toFixed(2);
    document.getElementById('lateralG').textContent = smooth.lateralG.toFixed(2);
    
    if(d.gps) {
        document.getElementById('sats').textContent = d.gps.satellites;
        document.getElementById('hdop').textContent = d.gps.hdop ? d.gps.hdop.toFixed(2) : '--';
        document.getElementById('maxSpeed').textContent = d.gps.maxSpeed ? d.gps.maxSpeed.toFixed(1) : '--';
        
        const badge = document.getElementById('gpsBadge');
        if(gpsOk) {
            badge.className = 'gps-badge fix';
            badge.textContent = d.gps.satellites + 'æ˜Ÿ';
        } else if(d.gps.satellites > 0) {
            badge.className = 'gps-badge search';
            badge.textContent = 'æœæ˜Ÿ';
        } else {
            badge.className = 'gps-badge off';
            badge.textContent = 'æ— ';
        }
    }
    
    if(d.performance) {
        document.getElementById('t100').textContent = d.performance.accel0to100 > 0 ? d.performance.accel0to100.toFixed(2) + 's' : '--';
        document.getElementById('b100').textContent = d.performance.brake100to0 > 0 ? d.performance.brake100to0.toFixed(2) + 's' : '--';
        document.getElementById('maxAG').textContent = d.performance.maxAccelG.toFixed(2) + ' G';
        document.getElementById('maxBG').textContent = d.performance.maxBrakeG.toFixed(2) + ' G';
        document.getElementById('maxLG').textContent = d.performance.maxLateralG.toFixed(2) + ' G';
    }
    
    // æ›²çº¿æ•°æ®
    const maxPts = Math.floor(timeRange * 1000 / CFG.interval);
    chart.ts.push(ts);
    chart.speed.push(smooth.speed);
    chart.gps.push(rawSpd);
    chart.accelG.push(smooth.accelG);
    chart.lateralG.push(smooth.lateralG);
    
    while(chart.ts.length > maxPts) {
        chart.ts.shift();
        chart.speed.shift();
        chart.gps.shift();
        chart.accelG.shift();
        chart.lateralG.shift();
    }
    
    // è®°å½•
    if(recording) {
        recData.push({
            t: ts - recStart,
            ts: new Date(ts).toISOString(),
            spd: smooth.speed,
            gpsSpd: rawSpd,
            aG: smooth.accelG,
            lG: smooth.lateralG,
            sat: d.gps ? d.gps.satellites : 0,
            hdop: d.gps ? d.gps.hdop : null,
            lat: d.gps ? d.gps.latitude : null,
            lng: d.gps ? d.gps.longitude : null,
            evt: null
        });
        document.getElementById('logCnt').textContent = recData.length;
        if(recData.length % 10 === 0) updateLog();
    }
    
    if(tab === 'live') draw();
}

function draw() {
    drawSpeed();
    drawGforce();
}

function drawSpeed() {
    const c = document.getElementById('speedChart');
    const ctx = sCtx;
    const w = c.width, h = c.height;
    
    ctx.fillStyle = '#0a0a1a';
    ctx.fillRect(0,0,w,h);
    
    if(chart.speed.length < 2) return;
    
    const maxS = Math.max(20, ...chart.speed, ...chart.gps) * 1.1;
    
    // ç½‘æ ¼
    ctx.strokeStyle = '#1a1a2e';
    ctx.lineWidth = 1;
    for(let i=0;i<=4;i++) {
        const y = h*i/4;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(w,y);
        ctx.stroke();
    }
    
    // GPSæ›²çº¿(è™šçº¿)
    ctx.strokeStyle = '#0088ff';
    ctx.lineWidth = 2;
    ctx.setLineDash([6,3]);
    ctx.beginPath();
    for(let i=0;i<chart.gps.length;i++) {
        const x = i/(chart.gps.length-1)*w;
        const y = h - chart.gps[i]/maxS*h;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
    
    // èåˆæ›²çº¿(å®çº¿)
    ctx.strokeStyle = '#00ff88';
    ctx.lineWidth = 3;
    ctx.setLineDash([]);
    ctx.beginPath();
    for(let i=0;i<chart.speed.length;i++) {
        const x = i/(chart.speed.length-1)*w;
        const y = h - chart.speed[i]/maxS*h;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
    
    // å½“å‰å€¼
    ctx.fillStyle = '#00ff88';
    ctx.font = 'bold 20px monospace';
    const cur = chart.speed[chart.speed.length-1] || 0;
    ctx.fillText(cur.toFixed(1) + ' km/h', w-130, 25);
}

function drawGforce() {
    const c = document.getElementById('gforceChart');
    const ctx = gCtx;
    const w = c.width, h = c.height;
    
    ctx.fillStyle = '#0a0a1a';
    ctx.fillRect(0,0,w,h);
    
    if(chart.accelG.length < 2) return;
    
    const maxG = Math.max(1, Math.max(...chart.accelG.map(Math.abs)), Math.max(...chart.lateralG.map(Math.abs))) * 1.2;
    
    // é›¶çº¿
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0,h/2);
    ctx.lineTo(w,h/2);
    ctx.stroke();
    
    // çºµå‘G
    ctx.strokeStyle = '#e94560';
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<chart.accelG.length;i++) {
        const x = i/(chart.accelG.length-1)*w;
        const y = h/2 - chart.accelG[i]/maxG*(h/2);
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
    
    // æ¨ªå‘G
    ctx.strokeStyle = '#ffd700';
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<chart.lateralG.length;i++) {
        const x = i/(chart.lateralG.length-1)*w;
        const y = h/2 - chart.lateralG[i]/maxG*(h/2);
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
}

function toggleRec() {
    recording = !recording;
    const b1 = document.getElementById('recBtn');
    const b2 = document.getElementById('recBtn2');
    const st = document.getElementById('recStatus');
    
    if(recording) {
        recStart = Date.now();
        recData = [];
        b1.innerHTML = 'â¹ åœæ­¢';
        b2.innerHTML = 'â¹ åœæ­¢';
        b1.style.background = '#e94560';
        b2.style.background = '#e94560';
        st.innerHTML = '<span class="rec-dot"></span>REC';
    } else {
        b1.innerHTML = 'âº å¼€å§‹è®°å½•';
        b2.innerHTML = 'âº å¼€å§‹è®°å½•';
        b1.style.background = '#00cc66';
        b2.style.background = '#00cc66';
        st.innerHTML = 'å·²åœæ­¢(' + recData.length + ')';
    }
}

function markEvent() {
    if(recording && recData.length > 0) {
        recData[recData.length-1].evt = 'MARK';
        updateLog();
    }
}

function updateLog() {
    const p = document.getElementById('logPanel');
    const hdr = p.children[0];
    p.innerHTML = '';
    p.appendChild(hdr);
    
    recData.slice(-30).reverse().forEach(d => {
        const row = document.createElement('div');
        row.className = 'log-row';
        const t = new Date(d.ts).toLocaleTimeString();
        row.innerHTML = `
            <span class="log-time">${t}</span>
            <span class="log-speed">${d.spd.toFixed(1)}</span>
            <span class="log-accel">${d.aG.toFixed(2)}</span>
            <span class="log-lat">${d.lG.toFixed(2)}</span>
            <span class="log-sats">${d.sat}</span>
            <span class="log-event">${d.evt||''}</span>
        `;
        p.appendChild(row);
    });
}

function clearLog() {
    if(confirm('æ¸…é™¤æ‰€æœ‰è®°å½•?')) {
        recData = [];
        document.getElementById('logCnt').textContent = '0';
        updateLog();
    }
}

function clearCharts() {
    chart = {speed:[],gps:[],accelG:[],lateralG:[],ts:[]};
    draw();
}

function setTimeRange() {
    timeRange = parseInt(document.getElementById('timeRange').value);
}

function updateUI() {
    if(recording) {
        const dur = Date.now() - recStart;
        document.getElementById('recTime').textContent = fmtTime(dur);
    }
}

function updateExport() {
    if(recData.length === 0) return;
    
    const size = JSON.stringify(recData).length / 1024;
    document.getElementById('dataSize').textContent = size.toFixed(1) + ' KB';
    
    const spds = recData.map(d => d.spd).filter(s => s > 0);
    const avg = spds.length ? spds.reduce((a,b)=>a+b,0)/spds.length : 0;
    const max = spds.length ? Math.max(...spds) : 0;
    const maxA = Math.max(...recData.map(d => d.aG));
    
    document.getElementById('avgSpd').textContent = avg.toFixed(1) + ' km/h';
    document.getElementById('expMax').textContent = max.toFixed(1) + ' km/h';
    document.getElementById('expAcc').textContent = maxA.toFixed(2) + ' G';
    
    drawPreview();
}

function drawPreview() {
    if(recData.length < 2) return;
    const c = document.getElementById('previewChart');
    const ctx = pCtx;
    const w = c.width, h = c.height;
    
    ctx.fillStyle = '#0a0a1a';
    ctx.fillRect(0,0,w,h);
    
    const data = recData.slice(-200);
    const maxS = Math.max(20, ...data.map(d=>d.spd)) * 1.1;
    
    ctx.strokeStyle = '#00ff88';
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<data.length;i++) {
        const x = i/(data.length-1)*w;
        const y = h - data[i].spd/maxS*h;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
}

function exportCSV() {
    if(!recData.length) return alert('æ— æ•°æ®');
    let csv = 'Time(ms),Timestamp,Speed,GPSSpeed,AccelG,LateralG,Sats,HDOP,Lat,Lng,Event\n';
    recData.forEach(d => {
        csv += `${d.t},${d.ts},${d.spd.toFixed(2)},${d.gpsSpd.toFixed(2)},${d.aG.toFixed(4)},${d.lG.toFixed(4)},${d.sat},${d.hdop||''},${d.lat||''},${d.lng||''},${d.evt||''}\n`;
    });
    download(csv, `draggy_${fmtDate()}.csv`, 'text/csv');
}

function exportJSON() {
    if(!recData.length) return alert('æ— æ•°æ®');
    const obj = {
        version: '2.0',
        device: 'ESP32 Draggy',
        time: new Date().toISOString(),
        count: recData.length,
        data: recData
    };
    download(JSON.stringify(obj,null,2), `draggy_${fmtDate()}.json`, 'application/json');
}

function copyData() {
    if(!recData.length) return alert('æ— æ•°æ®');
    const txt = recData.map(d => `${d.t}\t${d.spd.toFixed(2)}\t${d.aG.toFixed(3)}\t${d.lG.toFixed(3)}`).join('\n');
    navigator.clipboard.writeText(txt).then(() => alert('å·²å¤åˆ¶!'));
}

function download(content, name, type) {
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    a.click();
    URL.revokeObjectURL(url);
}

function fmtTime(ms) {
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const h = Math.floor(m/60);
    return `${h.toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
}

function fmtDate() {
    const n = new Date();
    return `${n.getFullYear()}${(n.getMonth()+1).toString().padStart(2,'0')}${n.getDate().toString().padStart(2,'0')}_${n.getHours().toString().padStart(2,'0')}${n.getMinutes().toString().padStart(2,'0')}`;
}
</script>
</body>
</html>
